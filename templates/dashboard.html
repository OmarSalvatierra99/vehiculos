{% extends "base.html" %}

{% block title %}Panel del usuario · Inventario vehicular{% endblock %}

{% block content %}
<section class="page-header">
  <div>
    <h2>Solicitud de unidades</h2>
    <p>Complete el formulario oficial para registrar la salida de una unidad.</p>
  </div>
</section>

<section class="grid">
  <div class="card">
    <div class="card-header">
      <h2>Registro de solicitud</h2>
      <p class="subtitle">Concentre datos clave en una sola captura.</p>
    </div>
    <form method="post" action="{{ url_for('solicitar') }}" class="form-sections">
      {% if error %}
      <div class="alert full">{{ error }}</div>
      {% endif %}

      <fieldset class="form-section">
        <legend>Unidad</legend>
        <label class="full">
          Placa de la unidad
          <select name="vehiculo_id" id="vehiculo_id" required>
            {% if vehiculos %}
              {% for vehiculo in vehiculos %}
              <option value="{{ vehiculo.id }}" data-marca="{{ vehiculo.marca }}" data-modelo="{{ vehiculo.modelo }}">{{ vehiculo.placa }}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled selected>No hay vehiculos registrados</option>
            {% endif %}
          </select>
        </label>
        <label>
          Marca
          <input type="text" id="marca_unidad" readonly required>
        </label>
        <label>
          Modelo
          <input type="text" id="modelo_unidad" readonly required>
        </label>
        <label class="full">
          Nombre del resguardante
          <input type="text" value="{{ usuario }}" readonly>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Personal</legend>
        <label class="full">
          Responsable del vehiculo
          <select name="responsable_usuario_id" required>
            {% if usuarios %}
              {% for usuario in usuarios %}
              <option value="{{ usuario.id }}">{{ usuario.nombre }}{% if usuario.puesto %} · {{ usuario.puesto }}{% endif %}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled selected>No hay usuarios registrados</option>
            {% endif %}
          </select>
        </label>
        <label>
          No. de pasajeros
          <input type="number" name="no_pasajeros" id="no_pasajeros" inputmode="numeric" min="0" max="4" step="1" value="4" required>
        </label>
        <label class="full">
          Nombre de los pasajeros
          <div class="combobox-container" id="pasajeros_container">
            <div class="combobox-search">
              <input type="search" id="pasajeros_search" class="combobox-input" placeholder="Buscar y seleccionar pasajeros..." autocomplete="off">
              <div id="pasajeros_dropdown" class="combobox-dropdown" hidden></div>
            </div>
            <select name="pasajeros_ids" id="pasajeros_ids" data-max="4" multiple hidden required>
              {% if usuarios %}
                {% for usuario in usuarios %}
                <option value="{{ usuario.id }}">{{ usuario.nombre }}{% if usuario.puesto %} · {{ usuario.puesto }}{% endif %}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No hay usuarios registrados</option>
              {% endif %}
            </select>
            <div class="combobox-meta">
              <span id="pasajeros_count" class="multi-count">0 seleccionados</span>
            </div>
            <div id="pasajeros_chips" class="combobox-chips" aria-live="polite">
              <span class="chip-empty">Ningún pasajero seleccionado</span>
            </div>
          </div>
          <div class="passenger-note">
            <strong>Importante</strong>
            <p>El conductor cuenta como pasajero. Seleccione exactamente el mismo numero indicado. Maximo 5 ocupantes en total.</p>
            <p>Esta estrictamente prohibido que en vehiculo oficial viajen mas de 5 ocupantes.</p>
          </div>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Ruta y motivo</legend>
        <label class="full">
          Ruta - destino
          <div class="combobox-container">
            <div class="combobox-search">
              <input type="search" id="ruta_search" class="combobox-input" placeholder="Buscar destino o dependencia..." autocomplete="off">
              <div id="ruta_dropdown" class="combobox-dropdown" hidden></div>
            </div>
            <select name="ruta_destinos" id="ruta_destinos" multiple hidden required>
              {% if entes %}
                {% for ente in entes %}
                <option value="{{ ente.clave }}" data-nombre="{{ ente.nombre }}">{{ ente.nombre }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No hay destinos registrados</option>
              {% endif %}
            </select>
            <div class="combobox-meta">
              <span id="ruta_count" class="multi-count">0 seleccionados</span>
            </div>
            <div id="ruta_chips" class="combobox-chips" aria-live="polite">
              <span class="chip-empty">Ningún destino seleccionado</span>
            </div>
          </div>
        </label>
        <label class="full">
          Motivo de salida
          <select name="motivo_salida" required>
            <option value="Notificación de Oficio">Notificación de Oficio</option>
            <option value="Revisión de Auditoría">Revisión de Auditoría</option>
            <option value="Entrega de Recepción">Entrega de Recepción</option>
            <option value="Compulsas">Compulsas</option>
            <option value="Inspección Física">Inspección Física</option>
          </select>
        </label>
      </fieldset>

      <div class="actions full">
        <button class="btn primary" type="submit">Registrar solicitud y generar reporte</button>
      </div>
    </form>
  </div>
  <div class="card">
    <div class="card-header">
      <h2>Prestamo entre usuarios</h2>
      <p class="subtitle">Solicite una unidad asignada a otro responsable.</p>
    </div>
    <form method="post" action="{{ url_for('solicitar_prestamo') }}" class="form-sections">
      {% if prestamo_error %}
      <div class="alert full">{{ prestamo_error }}</div>
      {% endif %}
      {% if prestamo_ok %}
      <div class="alert full">{{ prestamo_ok }}</div>
      {% endif %}
      <fieldset class="form-section">
        <legend>Unidad</legend>
        <label class="full">
          Vehiculo asignado
          <select name="prestamo_vehiculo" required>
            {% if vehiculos_prestables %}
              {% for vehiculo in vehiculos_prestables %}
              <option value="{{ vehiculo.id }}:{{ vehiculo.propietario_id }}">
                [{{ vehiculo.placa }}] {{ vehiculo.marca }} {{ vehiculo.modelo }} · {{ vehiculo.propietario_nombre }}
              </option>
              {% endfor %}
            {% else %}
              <option value="" disabled selected>No hay vehiculos prestables</option>
            {% endif %}
          </select>
        </label>
        <label class="full">
          Motivo del prestamo (opcional)
          <textarea name="prestamo_notas" rows="3" placeholder="Detalle breve de la solicitud"></textarea>
        </label>
      </fieldset>
      <div class="actions full">
        <button class="btn ghost" type="submit">Enviar solicitud de prestamo</button>
      </div>
    </form>
  </div>
</section>

<script>
  const vehiculoSelect = document.getElementById("vehiculo_id");
  const marcaInput = document.getElementById("marca_unidad");
  const modeloInput = document.getElementById("modelo_unidad");
  const noPasajerosInput = document.getElementById("no_pasajeros");
  const solicitudForm = document.querySelector("form.form-sections");

  // Actualizar marca y modelo cuando se selecciona un vehículo
  const actualizarVehiculo = () => {
    const selected = vehiculoSelect?.selectedOptions?.[0];
    if (!selected) {
      return;
    }
    marcaInput.value = selected.dataset.marca || "";
    modeloInput.value = selected.dataset.modelo || "";
  };

  if (vehiculoSelect) {
    vehiculoSelect.addEventListener("change", actualizarVehiculo);
    actualizarVehiculo();
  }

  const MAX_PASAJEROS = 4;

  // Sistema de combobox mejorado para selección múltiple
  function setupCombobox(searchInputId, dropdownId, selectId, chipsId, countId) {
    const searchInput = document.getElementById(searchInputId);
    const dropdown = document.getElementById(dropdownId);
    const selectEl = document.getElementById(selectId);
    const chipsContainer = document.getElementById(chipsId);
    const countEl = document.getElementById(countId);

    if (!searchInput || !dropdown || !selectEl || !chipsContainer || !countEl) {
      return;
    }

    const allOptions = Array.from(selectEl.options).filter(opt => !opt.disabled);
    const maxSelected = Number.parseInt(selectEl.dataset.max, 10);
    const requiresPassengerLimit = selectEl.id === "pasajeros_ids";
    let focusedIndex = -1;

    const updateCount = () => {
      const selected = selectEl.selectedOptions.length;
      countEl.textContent = `${selected} seleccionado${selected !== 1 ? 's' : ''}`;
    };

    const updateChips = () => {
      chipsContainer.innerHTML = "";
      const selected = Array.from(selectEl.selectedOptions);

      if (!selected.length) {
        const empty = document.createElement("span");
        empty.className = "chip-empty";
        empty.textContent = chipsContainer.getAttribute('data-empty') || "Ningún elemento seleccionado";
        chipsContainer.appendChild(empty);
        return;
      }

      selected.forEach((option) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip chip-removable";
        chip.innerHTML = `${option.textContent} <span class="chip-remove">×</span>`;
        chip.addEventListener("click", (e) => {
          e.preventDefault();
          option.selected = false;
          updateChips();
          updateCount();
        });
        chipsContainer.appendChild(chip);
      });
    };

    const filterOptions = (term) => {
      const normalizedTerm = term.toLowerCase().trim();
      return allOptions.filter(opt => {
        const isSelected = opt.selected;
        const label = (opt.dataset.nombre || opt.textContent).toLowerCase().trim();
        const matchesSearch = label.includes(normalizedTerm);
        return !isSelected && (normalizedTerm === "" || matchesSearch);
      });
    };

    const showDropdown = (options) => {
      dropdown.innerHTML = "";
      focusedIndex = -1;

      if (options.length === 0) {
        const noResults = document.createElement("div");
        noResults.className = "combobox-item combobox-no-results";
        noResults.textContent = "No se encontraron resultados";
        dropdown.appendChild(noResults);
        dropdown.hidden = false;
        return;
      }

      options.forEach((option, index) => {
        const item = document.createElement("button");
        item.type = "button";
        item.className = "combobox-item";
        item.textContent = option.textContent;
        item.dataset.value = option.value;
        item.dataset.index = index;

        item.addEventListener("click", (e) => {
          e.preventDefault();
          selectOption(option);
        });

        dropdown.appendChild(item);
      });

      dropdown.hidden = false;
    };

    const hideDropdown = () => {
      dropdown.hidden = true;
      focusedIndex = -1;
    };

    const selectOption = (option) => {
      let allowed = maxSelected;
      if (requiresPassengerLimit) {
        const allowedByInput = Number.parseInt(noPasajerosInput?.value, 10);
        allowed = Number.isFinite(allowedByInput) ? Math.min(allowedByInput, maxSelected) : maxSelected;
        if (!Number.isFinite(allowed) || allowed <= 0) {
          alert("Indique al menos 1 pasajero para poder seleccionar nombres.");
          return;
        }
      }
      if (Number.isFinite(allowed) && selectEl.selectedOptions.length >= allowed) {
        alert(`Solo puede seleccionar hasta ${allowed} pasajeros.`);
        return;
      }
      option.selected = true;
      searchInput.value = "";
      updateChips();
      updateCount();
      const remaining = filterOptions(searchInput.value);
      if (remaining.length) {
        showDropdown(remaining);
      } else {
        hideDropdown();
      }
      searchInput.focus();
    };

    const updateFocus = (newIndex) => {
      const items = dropdown.querySelectorAll(".combobox-item:not(.combobox-no-results):not(.combobox-info)");
      if (items.length === 0) return;

      items.forEach(item => item.classList.remove("focused"));

      if (newIndex >= 0 && newIndex < items.length) {
        focusedIndex = newIndex;
        items[focusedIndex].classList.add("focused");
        items[focusedIndex].scrollIntoView({ block: "nearest" });
      }
    };

    // Event listeners
    searchInput.addEventListener("input", () => {
      const filtered = filterOptions(searchInput.value);
      showDropdown(filtered);
    });

    searchInput.addEventListener("focus", () => {
      const filtered = filterOptions(searchInput.value);
      showDropdown(filtered);
    });

    searchInput.addEventListener("keydown", (e) => {
      const items = dropdown.querySelectorAll(".combobox-item:not(.combobox-no-results):not(.combobox-info)");

      switch(e.key) {
        case "ArrowDown":
          e.preventDefault();
          if (dropdown.hidden) {
            const filtered = filterOptions(searchInput.value);
            showDropdown(filtered);
          } else {
            updateFocus(Math.min(focusedIndex + 1, items.length - 1));
          }
          break;
        case "ArrowUp":
          e.preventDefault();
          updateFocus(Math.max(focusedIndex - 1, 0));
          break;
        case "Enter":
          e.preventDefault();
          if (focusedIndex >= 0 && focusedIndex < items.length) {
            const value = items[focusedIndex].dataset.value;
            const option = allOptions.find(opt => opt.value === value);
            if (option) selectOption(option);
          }
          break;
        case "Escape":
          e.preventDefault();
          hideDropdown();
          break;
      }
    });

    // Cerrar dropdown al hacer clic fuera
    document.addEventListener("click", (e) => {
      if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideDropdown();
      }
    });

    updateChips();
    updateCount();

    return { updateChips, updateCount, selectEl };
  }

  // Inicializar comboboxes
  const pasajerosCombobox = setupCombobox("pasajeros_search", "pasajeros_dropdown", "pasajeros_ids", "pasajeros_chips", "pasajeros_count");
  const rutaCombobox = setupCombobox("ruta_search", "ruta_dropdown", "ruta_destinos", "ruta_chips", "ruta_count");

  // Validación del formulario
  if (solicitudForm && noPasajerosInput) {
    const pasajerosContainer = document.getElementById("pasajeros_container");
    const clampPasajeros = () => {
      const value = Number.parseInt(noPasajerosInput.value, 10);
      if (!Number.isFinite(value)) {
        noPasajerosInput.value = MAX_PASAJEROS;
        return;
      }
      if (value > MAX_PASAJEROS) {
        noPasajerosInput.value = MAX_PASAJEROS;
      } else if (value < 0) {
        noPasajerosInput.value = 0;
      }
    };

    const enforcePassengerLimit = () => {
      clampPasajeros();
      const pasajerosSelect = document.getElementById("pasajeros_ids");
      if (!pasajerosSelect) {
        return;
      }
      const allowed = Number.parseInt(noPasajerosInput.value, 10);
      if (!Number.isFinite(allowed)) {
        return;
      }
      if (pasajerosContainer) {
        pasajerosContainer.hidden = allowed === 0;
      }
      if (allowed === 0) {
        Array.from(pasajerosSelect.selectedOptions).forEach(option => {
          option.selected = false;
        });
      } else if (pasajerosSelect.selectedOptions.length > allowed) {
        const selected = Array.from(pasajerosSelect.selectedOptions);
        selected.slice(allowed).forEach(option => {
          option.selected = false;
        });
      }
      pasajerosCombobox?.updateChips();
      pasajerosCombobox?.updateCount();
    };

    noPasajerosInput.addEventListener("input", enforcePassengerLimit);
    enforcePassengerLimit();

    solicitudForm.addEventListener("submit", (event) => {
      const pasajerosSelect = document.getElementById("pasajeros_ids");
      const total = Number.parseInt(noPasajerosInput.value, 10);
      const seleccionados = pasajerosSelect.selectedOptions.length;

      if (!Number.isFinite(total) || total < 0 || total > MAX_PASAJEROS || total !== seleccionados) {
        event.preventDefault();
        alert(`El número de pasajeros debe ser de 0 a ${MAX_PASAJEROS} y coincidir con los nombres seleccionados.\nIndicado: ${total}, Seleccionados: ${seleccionados}`);
      }
    });
  }
</script>

{% endblock %}
