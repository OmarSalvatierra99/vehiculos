{% extends "base.html" %}

{% block title %}Panel del usuario · Inventario vehicular{% endblock %}

{% block content %}
<section class="page-header">
  <div>
    <h2>Solicitud de unidades</h2>
    <p>Complete el formulario oficial para registrar la salida de una unidad.</p>
  </div>
</section>

<section class="grid">
  <div class="card">
    <div class="card-header">
      <h2>Registro de solicitud</h2>
      <p class="subtitle">Concentre datos clave en una sola captura.</p>
    </div>
    <form method="post" action="{{ url_for('solicitar') }}" class="form-sections">
      {% if error %}
      <div class="alert full">{{ error }}</div>
      {% endif %}

      <fieldset class="form-section">
        <legend>Unidad</legend>
        <label class="full">
          Placa de la unidad
          <select name="vehiculo_id" id="vehiculo_id" required>
            {% if vehiculos %}
              {% for vehiculo in vehiculos %}
              <option value="{{ vehiculo.id }}" data-marca="{{ vehiculo.marca }}" data-modelo="{{ vehiculo.modelo }}">{{ vehiculo.placa }} · {{ vehiculo.modelo }}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled selected>No hay placas registradas</option>
            {% endif %}
          </select>
        </label>
        <label>
          Marca
          <input type="text" name="marca" id="marca_unidad" value="{% if vehiculos %}{{ vehiculos[0].marca }}{% endif %}" readonly required>
        </label>
        <label>
          Modelo
          <input type="text" name="modelo" id="modelo_unidad" value="{% if vehiculos %}{{ vehiculos[0].modelo }}{% endif %}" readonly required>
        </label>
        <label class="full">
          Responsable del vehiculo
          <select name="responsable_id" required>
            {% for responsable in responsables %}
            <option value="{{ responsable.id }}">{{ responsable.nombre }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          No. de pasajeros
          <input type="number" name="no_pasajeros" min="1" max="10" required>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Personal</legend>
        <label class="full">
          Personal solicitante
          <input type="text" name="personal_nombre" id="personal_nombre" placeholder="Nombre completo" required>
        </label>
        <label class="full">
          Nombre de los auditores
          <select name="auditores_ids" multiple size="4" required>
            {% for auditor in auditores %}
            <option value="{{ auditor.id }}">{{ auditor.nombre }}</option>
            {% endfor %}
          </select>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Ruta y motivo</legend>
        <label class="full">
          Buscar ente destino
          <input type="text" id="ruta_busqueda" list="ruta_entes" placeholder="Escriba clave o nombre del ente">
          <datalist id="ruta_entes">
            <option value="TLAXCALA" label="Tlaxcala"></option>
            <option value="VARIOS" label="Varios"></option>
            {% for ente in entes_ruta %}
            <option value="{{ ente.clave }}" label="{{ ente.siglas or ente.nombre }} · {{ ente.nombre }}{% if ente.direccion %} · {{ ente.direccion }}{% endif %}"></option>
            {% endfor %}
          </datalist>
          <p class="hint">Seleccione un ente y se agregara a la ruta de destinos.</p>
        </label>
        <label class="full">
          Ruta - destinos
          <select name="ruta_destinos" multiple size="5" required>
            <option value="TLAXCALA">Tlaxcala</option>
            <option value="VARIOS">Varios</option>
            {% for ente in entes_ruta %}
            <option value="{{ ente.clave }}">{{ ente.siglas or ente.nombre }} · {{ ente.nombre }}{% if ente.direccion %} · {{ ente.direccion }}{% endif %}</option>
            {% endfor %}
          </select>
          <p class="hint">Seleccione los entes destino en el orden de la lista.</p>
        </label>
        <label class="full">
          Motivo de salida
          <select name="motivo_salida" required>
            <option value="Notificación de oficio">Notificación de oficio</option>
            <option value="Revision de auditoria">Revision de auditoria</option>
          </select>
        </label>
      </fieldset>

      <div class="actions full">
        <button class="btn primary" type="submit">Registrar solicitud y generar reporte</button>
      </div>
    </form>
</section>

<script>
  const vehiculoSelect = document.getElementById("vehiculo_id");
  const marcaInput = document.getElementById("marca_unidad");
  const modeloInput = document.getElementById("modelo_unidad");
  const rutaBusqueda = document.getElementById("ruta_busqueda");
  const rutaSelect = document.querySelector("select[name='ruta_destinos']");

  const actualizarVehiculo = () => {
    const selected = vehiculoSelect?.selectedOptions?.[0];
    if (!selected) {
      return;
    }
    marcaInput.value = selected.dataset.marca || "";
    modeloInput.value = selected.dataset.modelo || "";
  };

  if (vehiculoSelect) {
    vehiculoSelect.addEventListener("change", actualizarVehiculo);
    actualizarVehiculo();
  }

  const agregarDestino = () => {
    if (!rutaBusqueda || !rutaSelect) {
      return;
    }
    const value = rutaBusqueda.value.trim();
    if (!value) {
      return;
    }
    const match = Array.from(rutaSelect.options).find(
      (option) => option.value.toUpperCase() === value.toUpperCase(),
    );
    if (match) {
      match.selected = true;
    }
    rutaBusqueda.value = "";
  };

  if (rutaBusqueda) {
    rutaBusqueda.addEventListener("change", agregarDestino);
    rutaBusqueda.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        agregarDestino();
      }
    });
  }
</script>

{% endblock %}
