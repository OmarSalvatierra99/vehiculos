{% extends "base.html" %}

{% block title %}Panel del usuario · Inventario vehicular{% endblock %}

{% block content %}
<section class="page-header">
  <div>
    <h2>Solicitud de unidades</h2>
    <p>Complete el formulario oficial para registrar la salida de una unidad.</p>
  </div>
</section>

<section class="grid">
  <div class="card">
    <div class="card-header">
      <h2>Registro de solicitud</h2>
      <p class="subtitle">Concentre datos clave en una sola captura.</p>
    </div>
    <form method="post" action="{{ url_for('solicitar') }}" class="form-sections" id="solicitud_form">
      {% if error %}
      <div class="alert full">{{ error }}</div>
      {% endif %}
      {% if ok %}
      <div class="alert full">{{ ok }}</div>
      {% endif %}

      <div class="passenger-note full">
        <strong>Horario de recepción</strong>
        <p>Las solicitudes de vehiculo se reciben hasta las 19:00 h.</p>
      </div>

      <fieldset class="form-section">
        <legend>Tipo de solicitud</legend>
        <label class="full">
          Tipo de solicitud
          <select name="tipo_solicitud" id="tipo_solicitud" required>
            <option value="normal" {% if tipo_solicitud != "prestamo" %}selected{% endif %}>Solicitud de unidad</option>
            <option value="prestamo" {% if tipo_solicitud == "prestamo" %}selected{% endif %}>Préstamo entre usuarios</option>
          </select>
        </label>
        <p class="hint">Use la opción de préstamo para apartar unidades de otro usuario dentro de los dias habiles permitidos.</p>
      </fieldset>

      <fieldset class="form-section" id="solicitud_fecha_section">
        <legend>Fecha de solicitud</legend>
        <label class="full">
          Fecha de salida
          <input type="date" name="fecha_solicitud" id="fecha_solicitud" value="{{ fecha_solicitud }}" min="{{ fecha_min }}" max="{{ fecha_max }}" required>
        </label>
        <p class="hint">La unidad se aparta solo para el dia seleccionado.</p>
      </fieldset>

      <fieldset class="form-section">
        <legend>Unidad</legend>
        <label class="full">
          Placa de la unidad
          <select name="vehiculo_id" id="vehiculo_id" required>
            {% if vehiculos %}
            <optgroup label="Mis unidades">
              {% for vehiculo in vehiculos %}
              <option value="{{ vehiculo.id }}:{{ usuario_id }}"
                data-scope="propio"
                data-marca="{{ vehiculo.marca }}"
                data-modelo="{{ vehiculo.modelo }}"
                data-placa="{{ vehiculo.placa }}"
                data-propietario="{{ usuario }}">
                {{ vehiculo.placa }}
              </option>
              {% endfor %}
            </optgroup>
            {% endif %}
            {% if vehiculos_prestables %}
            <optgroup label="Unidades de otros usuarios">
              {% for vehiculo in vehiculos_prestables %}
              <option value="{{ vehiculo.id }}:{{ vehiculo.propietario_id }}"
                data-scope="prestamo"
                data-placa="{{ vehiculo.placa }}"
                data-privado="true">
                {{ vehiculo.placa }}
              </option>
              {% endfor %}
            </optgroup>
            {% endif %}
            {% if not vehiculos and not vehiculos_prestables %}
              <option value="" disabled selected>No hay vehiculos disponibles</option>
            {% endif %}
          </select>
        </label>
        <div class="full unit-summary" id="unidad_resumen">
          <div>
            <span class="summary-label">Unidad seleccionada</span>
            <strong id="unidad_placa">Seleccione una unidad</strong>
          </div>
          <div>
            <span class="summary-label">Marca y modelo</span>
            <strong id="unidad_modelo">-</strong>
          </div>
          <div>
            <span class="summary-label">Responsable actual</span>
            <strong id="unidad_propietario">-</strong>
          </div>
        </div>
        <label class="full">
          Nombre del resguardante
          <input type="text" value="{{ usuario }}" readonly>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Personal</legend>
        <label class="full">
          Responsable del vehiculo
          <select name="responsable_usuario_id" id="responsable_usuario_id" required>
            {% if resguardante_disponible %}
            <option
              value="{{ usuario_id }}"
              {% if auditor_resguardante_id %}data-auditor-id="{{ auditor_resguardante_id }}"{% endif %}
            >
              {{ usuario }} (Resguardante)
            </option>
            {% endif %}
            {% if responsables %}
              {% for responsable in responsables %}
              <option value="auditor:{{ responsable.id }}">{{ responsable.nombre }}</option>
              {% endfor %}
            {% elif not resguardante_disponible %}
              <option value="" disabled selected>No hay personal registrado</option>
            {% endif %}
          </select>
        </label>
        <label>
          No. de pasajeros
          <input type="number" name="no_pasajeros" id="no_pasajeros" inputmode="numeric" min="0" max="4" step="1" value="4" required>
        </label>
        <label class="full" id="pasajeros_label">
          <div class="actions-inline">
            <span>Nombre de los auditores</span>
            <button class="btn ghost btn-small" type="button" id="pasajeros_compulsa" aria-pressed="false">Compulsa</button>
          </div>
          <div class="combobox-container" id="pasajeros_container">
            <div class="combobox-search">
              <input type="search" id="pasajeros_search" class="combobox-input" placeholder="Buscar y seleccionar auditores..." autocomplete="off">
              <div id="pasajeros_dropdown" class="combobox-dropdown" hidden></div>
            </div>
            <select name="pasajeros_ids" id="pasajeros_ids" data-max="4" multiple hidden>
              {% if auditores %}
                {% for auditor in auditores %}
                <option value="{{ auditor.id }}">{{ auditor.nombre }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No hay auditores registrados</option>
              {% endif %}
            </select>
            <select id="pasajeros_ids_all" hidden>
              {% if auditores_ofs %}
                {% for auditor in auditores_ofs %}
                <option value="{{ auditor.id }}">{{ auditor.nombre }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No hay auditores registrados</option>
              {% endif %}
            </select>
            <div class="combobox-meta">
              <span id="pasajeros_count" class="multi-count">0 seleccionados</span>
            </div>
            <div id="pasajeros_chips" class="combobox-chips" aria-live="polite">
              <span class="chip-empty">Ningún auditor seleccionado</span>
            </div>
          </div>
          <p class="hint" id="pasajeros_compulsa_hint">Mostrando personal a tu cargo.</p>
          <div class="passenger-note">
            <strong>Importante</strong>
            <p>El conductor cuenta como pasajero. Seleccione únicamente el número de acompañantes</p>
            <p>Esta estrictamente prohibido que en vehiculo oficial viajen mas de 5 ocupantes.</p>
          </div>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Ruta y motivo</legend>
        <label class="full">
          Ruta - destino
          <div class="combobox-container">
            <div class="combobox-search">
              <input type="search" id="ruta_search" class="combobox-input" placeholder="Buscar destino o dependencia..." autocomplete="off">
              <div id="ruta_dropdown" class="combobox-dropdown" hidden></div>
            </div>
            <select name="ruta_destinos" id="ruta_destinos" multiple hidden required>
              {% if entes %}
                {% for ente in entes %}
                <option value="{{ ente.clave }}" data-nombre="{{ ente.nombre }}">{{ ente.nombre }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No hay destinos registrados</option>
              {% endif %}
            </select>
            <div class="combobox-meta">
              <span id="ruta_count" class="multi-count">0 seleccionados</span>
            </div>
            <div id="ruta_chips" class="combobox-chips" aria-live="polite">
              <span class="chip-empty">Ningún destino seleccionado</span>
            </div>
          </div>
        </label>
        <label class="full">
          Motivo de salida
          <select name="motivo_salida" required>
            <option value="Notificación de Oficio">Notificación de Oficio</option>
            <option value="Revisión de Auditoría">Revisión de Auditoría</option>
            <option value="Entrega de Recepción">Entrega de Recepción</option>
            <option value="Acta de Cierre">Acta de Cierre</option>
            <option value="Compulsas">Compulsas</option>
            <option value="Inspección Física">Inspección Física</option>
          </select>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Solicitudes registradas</legend>
        <p class="subtitle full">Vehiculos solicitados por ti con ruta, responsable y pasajeros</p>
        {% if mis_movimientos %}
        <div class="table table-5 full">
          <div class="table-row header">
            <span>Unidad</span>
            <span>Fecha solicitud</span>
            <span>Ruta</span>
            <span>Responsable</span>
            <span>Pasajeros</span>
          </div>
          {% for mov in mis_movimientos %}
          <div class="table-row">
            <span class="mono">
              {{ mov.placa_unidad or '-' }}
              {% if mov.marca or mov.modelo %}
              <small>{{ mov.marca or '' }} {{ mov.modelo or '' }}</small>
              {% endif %}
            </span>
            <span>{{ mov.fecha_solicitud or '-' }}</span>
            <span>{{ mov.ruta_destino or 'Sin ruta' }}</span>
            <span>{{ mov.responsable_vehiculo or 'Sin responsable' }}</span>
            <span>{{ mov.pasajeros_nombres or 'Sin pasajeros' }}</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="empty full">No hay solicitudes registradas.</p>
        {% endif %}
      </fieldset>

      {% if movimientos_usuarios_observados is defined %}
      <fieldset class="form-section">
        <legend>Solicitudes de Ramos y Mike</legend>
        <p class="subtitle full">Visualizacion especial para el usuario Omar.</p>
        {% if movimientos_usuarios_observados %}
        <div class="table table-7 full">
          <div class="table-row header">
            <span>Solicitante</span>
            <span>Unidad</span>
            <span>Fecha</span>
            <span>Ruta</span>
            <span>Responsable</span>
            <span>Pasajeros</span>
            <span>Estatus</span>
          </div>
          {% for mov in movimientos_usuarios_observados %}
          <div class="table-row">
            <span>{{ mov.usuario_nombre }}</span>
            <span class="mono">
              {{ mov.placa_unidad or '-' }}
              {% if mov.marca or mov.modelo %}
              <small>{{ mov.marca or '' }} {{ mov.modelo or '' }}</small>
              {% endif %}
            </span>
            <span>{{ mov.fecha_solicitud or '-' }}</span>
            <span>{{ mov.ruta_destino or 'Sin ruta' }}</span>
            <span>{{ mov.responsable_vehiculo or 'Sin responsable' }}</span>
            <span>{{ mov.pasajeros_nombres or 'Sin pasajeros' }}</span>
            <span>
              {% if mov.rechazado %}
                Rechazado
              {% elif mov.devuelto %}
                Devuelto
              {% elif mov.fecha_entrega %}
                En uso
              {% elif mov.conflicto %}
                Conflicto
              {% else %}
                Pendiente
              {% endif %}
            </span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="empty full">No hay solicitudes registradas.</p>
        {% endif %}
      </fieldset>
      {% endif %}

      <fieldset class="form-section" id="observaciones_section" hidden>
        <label class="full">
          Observaciones (opcional)
          <textarea name="notas" rows="3" placeholder="Detalle breve de la solicitud"></textarea>
        </label>
      </fieldset>

      <div class="actions full">
        <button class="btn primary" type="submit" id="solicitud_submit">Registrar solicitud</button>
      </div>
    </form>
  </div>

</section>

<script>
  const tipoSelect = document.getElementById("tipo_solicitud");
  const vehiculoSelect = document.getElementById("vehiculo_id");
  const unidadPlaca = document.getElementById("unidad_placa");
  const unidadModelo = document.getElementById("unidad_modelo");
  const unidadPropietario = document.getElementById("unidad_propietario");
  const solicitudFechaSection = document.getElementById("solicitud_fecha_section");
  const fechaSolicitudInput = document.getElementById("fecha_solicitud");
  const observacionesSection = document.getElementById("observaciones_section");
  const solicitudForm = document.getElementById("solicitud_form");
  const submitBtn = document.getElementById("solicitud_submit");
  const noPasajerosInput = document.getElementById("no_pasajeros");
  const responsableSelect = document.getElementById("responsable_usuario_id");
  const pasajerosSelect = document.getElementById("pasajeros_ids");
  const pasajerosSelectAll = document.getElementById("pasajeros_ids_all");
  const pasajerosSelectDefault = pasajerosSelect ? pasajerosSelect.cloneNode(true) : null;

  const updateUnidadResumen = () => {
    if (!vehiculoSelect) {
      return;
    }
    const selected = vehiculoSelect.selectedOptions?.[0];
    if (!selected) {
      unidadPlaca.textContent = "Seleccione una unidad";
      unidadModelo.textContent = "-";
      unidadPropietario.textContent = "-";
      return;
    }
    unidadPlaca.textContent = selected.dataset.placa || "Unidad seleccionada";
    if (selected.dataset.privado === "true") {
      unidadModelo.textContent = "-";
      unidadPropietario.textContent = "-";
      return;
    }
    const marca = selected.dataset.marca || "-";
    const modelo = selected.dataset.modelo || "-";
    unidadModelo.textContent = `${marca} ${modelo}`.trim();
    unidadPropietario.textContent = selected.dataset.propietario || "-";
  };

  const applyTipoFiltro = () => {
    const tipo = (tipoSelect?.value || "normal").toLowerCase();
    const esPrestamo = tipo === "prestamo";
    if (solicitudFechaSection) {
      solicitudFechaSection.hidden = false;
      solicitudFechaSection.style.display = "grid";
    }
    if (fechaSolicitudInput) {
      fechaSolicitudInput.required = true;
    }
    if (observacionesSection) {
      observacionesSection.hidden = !esPrestamo;
      observacionesSection.style.display = esPrestamo ? "grid" : "none";
    }
    if (submitBtn) {
      submitBtn.textContent = esPrestamo ? "Registrar préstamo" : "Registrar solicitud";
    }
    if (vehiculoSelect) {
      const options = Array.from(vehiculoSelect.options);
      let selectedVisible = false;
      options.forEach((opt) => {
        const scope = opt.dataset.scope;
        if (!scope) {
          return;
        }
        const visible = esPrestamo ? scope === "prestamo" : scope === "propio";
        opt.hidden = !visible;
        if (opt.selected && visible) {
          selectedVisible = true;
        }
      });
      if (!selectedVisible) {
        const firstVisible = options.find(opt => !opt.hidden && !opt.disabled);
        if (firstVisible) {
          firstVisible.selected = true;
        }
      }
    }
    updateUnidadResumen();
  };

  if (vehiculoSelect) {
    vehiculoSelect.addEventListener("change", updateUnidadResumen);
    updateUnidadResumen();
  }
  if (tipoSelect) {
    tipoSelect.addEventListener("change", applyTipoFiltro);
  }
  if (fechaSolicitudInput) {
    fechaSolicitudInput.addEventListener("change", () => {
      const value = fechaSolicitudInput.value;
      if (!value) {
        return;
      }
      const state = clampToWorkweek(value);
      fechaSolicitudInput.min = state.minIso;
      fechaSolicitudInput.max = state.maxIso;
      if (!state.ok) {
        fechaSolicitudInput.value = state.value;
        alert("Seleccione una fecha dentro de los dias habiles permitidos.");
        return;
      }
      const url = new URL(window.location.href);
      url.searchParams.set("fecha", state.value);
      window.location.href = url.toString();
    });
  }

  const isoDate = (dt) => {
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, "0");
    const day = String(dt.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  };

  const clampToWorkweek = (dateValue) => {
    const today = new Date();
    const minDate = new Date(today);
    const day = minDate.getDay();
    if (day === 0 || day === 6) {
      const daysToMonday = (8 - day) % 7;
      minDate.setDate(minDate.getDate() + daysToMonday);
    }

    const maxDate = new Date(minDate);
    let counted = 1;
    while (counted < 5) {
      maxDate.setDate(maxDate.getDate() + 1);
      if (maxDate.getDay() !== 0 && maxDate.getDay() !== 6) {
        counted += 1;
      }
    }

    const minIso = isoDate(minDate);
    const maxIso = isoDate(maxDate);
    if (!dateValue) {
      return { ok: false, minIso, maxIso, value: minIso };
    }
    const picked = new Date(`${dateValue}T00:00:00`);
    const isWeekend = picked.getDay() === 0 || picked.getDay() === 6;
    if (Number.isNaN(picked.getTime()) || isWeekend || dateValue < minIso || dateValue > maxIso) {
      return { ok: false, minIso, maxIso, value: minIso };
    }
    return { ok: true, minIso, maxIso, value: dateValue };
  };

  const setupSolicitudFecha = () => {
    if (!fechaSolicitudInput) {
      return;
    }
    const state = clampToWorkweek(fechaSolicitudInput.value);
    fechaSolicitudInput.min = state.minIso;
    fechaSolicitudInput.max = state.maxIso;
    if (fechaSolicitudInput.value !== state.value) {
      fechaSolicitudInput.value = state.value;
    }
  };

  setupSolicitudFecha();
  applyTipoFiltro();

  const MAX_PASAJEROS = 4;

  function setupCombobox(searchInputId, dropdownId, selectId, chipsId, countId, passengerLimitInput, excludeLabelFn) {
    const searchInput = document.getElementById(searchInputId);
    const dropdown = document.getElementById(dropdownId);
    const selectEl = document.getElementById(selectId);
    const chipsContainer = document.getElementById(chipsId);
    const countEl = document.getElementById(countId);

    if (!searchInput || !dropdown || !selectEl || !chipsContainer || !countEl) {
      return;
    }

    let allOptions = Array.from(selectEl.options).filter(opt => !opt.disabled);
    const maxSelected = Number.parseInt(selectEl.dataset.max, 10);
    const requiresPassengerLimit = Boolean(passengerLimitInput);
    let focusedIndex = -1;

    const refreshOptions = () => {
      allOptions = Array.from(selectEl.options).filter(opt => !opt.disabled);
    };

    const updateCount = () => {
      const selected = selectEl.selectedOptions.length;
      countEl.textContent = `${selected} seleccionado${selected !== 1 ? 's' : ''}`;
    };

    const updateChips = () => {
      chipsContainer.innerHTML = "";
      const selected = Array.from(selectEl.selectedOptions);

      if (!selected.length) {
        const empty = document.createElement("span");
        empty.className = "chip-empty";
        empty.textContent = chipsContainer.getAttribute('data-empty') || "Ningún elemento seleccionado";
        chipsContainer.appendChild(empty);
        return;
      }

      selected.forEach((option) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip chip-removable";
        chip.innerHTML = `${option.textContent} <span class="chip-remove">×</span>`;
        chip.addEventListener("click", (e) => {
          e.preventDefault();
          option.selected = false;
          updateChips();
          updateCount();
        });
        chipsContainer.appendChild(chip);
      });
    };

    const filterOptions = (term) => {
      const normalizedTerm = term.toLowerCase().trim();
      return allOptions.filter(opt => {
        const isSelected = opt.selected;
        const label = (opt.dataset.nombre || opt.textContent).toLowerCase().trim();
        if (excludeLabelFn && excludeLabelFn(label, opt)) {
          return false;
        }
        const matchesSearch = label.includes(normalizedTerm);
        return !isSelected && (normalizedTerm === "" || matchesSearch);
      });
    };

    const showDropdown = (options) => {
      dropdown.innerHTML = "";
      focusedIndex = -1;

      if (options.length === 0) {
        const noResults = document.createElement("div");
        noResults.className = "combobox-item combobox-no-results";
        noResults.textContent = "No se encontraron resultados";
        dropdown.appendChild(noResults);
        dropdown.hidden = false;
        return;
      }

      options.forEach((option, index) => {
        const item = document.createElement("button");
        item.type = "button";
        item.className = "combobox-item";
        item.textContent = option.textContent;
        item.dataset.value = option.value;
        item.dataset.index = index;

        item.addEventListener("click", (e) => {
          e.preventDefault();
          selectOption(option);
        });

        dropdown.appendChild(item);
      });

      dropdown.hidden = false;
    };

    const hideDropdown = () => {
      dropdown.hidden = true;
      focusedIndex = -1;
    };

    const selectOption = (option) => {
      let allowed = maxSelected;
      if (requiresPassengerLimit) {
        const allowedByInput = Number.parseInt(passengerLimitInput?.value, 10);
        allowed = Number.isFinite(allowedByInput) ? Math.min(allowedByInput, maxSelected) : maxSelected;
        if (!Number.isFinite(allowed) || allowed <= 0) {
          alert("Indique al menos 1 pasajero para poder seleccionar nombres.");
          return;
        }
      }
      if (Number.isFinite(allowed) && selectEl.selectedOptions.length >= allowed) {
        alert(`Solo puede seleccionar hasta ${allowed} pasajeros.`);
        return;
      }
      option.selected = true;
      searchInput.value = "";
      updateChips();
      updateCount();
      const remaining = filterOptions(searchInput.value);
      if (remaining.length) {
        showDropdown(remaining);
      } else {
        hideDropdown();
      }
      searchInput.focus();
    };

    const updateFocus = (newIndex) => {
      const items = dropdown.querySelectorAll(".combobox-item:not(.combobox-no-results):not(.combobox-info)");
      if (items.length === 0) return;

      items.forEach(item => item.classList.remove("focused"));

      if (newIndex >= 0 && newIndex < items.length) {
        focusedIndex = newIndex;
        items[focusedIndex].classList.add("focused");
        items[focusedIndex].scrollIntoView({ block: "nearest" });
      }
    };

    searchInput.addEventListener("input", () => {
      const filtered = filterOptions(searchInput.value);
      showDropdown(filtered);
    });

    searchInput.addEventListener("focus", () => {
      const filtered = filterOptions(searchInput.value);
      showDropdown(filtered);
    });

    searchInput.addEventListener("keydown", (e) => {
      const items = dropdown.querySelectorAll(".combobox-item:not(.combobox-no-results):not(.combobox-info)");

      switch(e.key) {
        case "ArrowDown":
          e.preventDefault();
          if (dropdown.hidden) {
            const filtered = filterOptions(searchInput.value);
            showDropdown(filtered);
          } else {
            updateFocus(Math.min(focusedIndex + 1, items.length - 1));
          }
          break;
        case "ArrowUp":
          e.preventDefault();
          updateFocus(Math.max(focusedIndex - 1, 0));
          break;
        case "Enter":
          e.preventDefault();
          if (focusedIndex >= 0 && focusedIndex < items.length) {
            const value = items[focusedIndex].dataset.value;
            const option = allOptions.find(opt => opt.value === value);
            if (option) selectOption(option);
          }
          break;
        case "Escape":
          e.preventDefault();
          hideDropdown();
          break;
      }
    });

    document.addEventListener("click", (e) => {
      if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideDropdown();
      }
    });

    updateChips();
    updateCount();
    refreshOptions();

    if (excludeLabelFn) {
      const syncExclusions = () => {
        Array.from(selectEl.selectedOptions).forEach((opt) => {
          const label = (opt.dataset.nombre || opt.textContent).toLowerCase().trim();
          if (excludeLabelFn(label, opt)) {
            opt.selected = false;
          }
        });
        updateChips();
        updateCount();
      };
      syncExclusions();
      if (responsableSelect) {
        responsableSelect.addEventListener("change", syncExclusions);
      }
    }

    return { updateChips, updateCount, selectEl, refreshOptions };
  }

  const pasajerosCombobox = setupCombobox(
    "pasajeros_search",
    "pasajeros_dropdown",
    "pasajeros_ids",
    "pasajeros_chips",
    "pasajeros_count",
    noPasajerosInput,
    (label, opt) => {
      const responsableValue = responsableSelect?.value || "";
      const responsableId = responsableValue.startsWith("auditor:")
        ? responsableValue.split(":")[1]?.trim()
        : "";
      return Boolean(responsableId && opt?.value === responsableId);
    },
  );
  const rutaCombobox = setupCombobox("ruta_search", "ruta_dropdown", "ruta_destinos", "ruta_chips", "ruta_count");
  const compulsaBtn = document.getElementById("pasajeros_compulsa");
  const compulsaHint = document.getElementById("pasajeros_compulsa_hint");
  let compulsaActiva = false;

  const aplicarListaAuditores = (sourceSelect, hintText) => {
    if (!pasajerosSelect || !sourceSelect) {
      return;
    }
    const selectedValues = new Set(Array.from(pasajerosSelect.selectedOptions).map(opt => opt.value));
    pasajerosSelect.innerHTML = "";
    const options = Array.from(sourceSelect.options);
    if (!options.length) {
      const empty = document.createElement("option");
      empty.value = "";
      empty.disabled = true;
      empty.textContent = "No hay auditores registrados";
      pasajerosSelect.appendChild(empty);
    } else {
      options.forEach((opt) => {
        const clone = opt.cloneNode(true);
        clone.selected = selectedValues.has(clone.value);
        pasajerosSelect.appendChild(clone);
      });
    }
    pasajerosCombobox?.refreshOptions?.();
    pasajerosCombobox?.updateChips?.();
    pasajerosCombobox?.updateCount?.();
    if (compulsaHint) {
      compulsaHint.textContent = hintText;
    }
  };

  if (compulsaBtn) {
    compulsaBtn.addEventListener("click", () => {
      compulsaActiva = !compulsaActiva;
      compulsaBtn.setAttribute("aria-pressed", String(compulsaActiva));
      compulsaBtn.classList.toggle("primary", compulsaActiva);
      const source = compulsaActiva ? pasajerosSelectAll : pasajerosSelectDefault;
      const hintText = compulsaActiva
        ? "Mostrando todo el personal del OFS."
        : "Mostrando personal a tu cargo.";
      aplicarListaAuditores(source, hintText);
    });
  }

  const setupPassengerValidation = (formEl, pasajerosInput, pasajerosSelectId, pasajerosCombobox, containerId, labelId) => {
    if (!formEl || !pasajerosInput) {
      return;
    }
    const pasajerosContainer = document.getElementById(containerId);
    const pasajerosLabel = document.getElementById(labelId);
    const pasajerosSearch = document.getElementById("pasajeros_search");
    const pasajerosDropdown = document.getElementById("pasajeros_dropdown");
    const clampPasajeros = () => {
      const value = Number.parseInt(pasajerosInput.value, 10);
      if (!Number.isFinite(value)) {
        pasajerosInput.value = MAX_PASAJEROS;
        return;
      }
      if (value > MAX_PASAJEROS) {
        pasajerosInput.value = MAX_PASAJEROS;
      } else if (value < 0) {
        pasajerosInput.value = 0;
      }
    };

    const enforcePassengerLimit = () => {
      clampPasajeros();
      const pasajerosSelect = document.getElementById(pasajerosSelectId);
      if (!pasajerosSelect) {
        return;
      }
      const allowed = Number.parseInt(pasajerosInput.value, 10);
      if (!Number.isFinite(allowed)) {
        return;
      }
      if (pasajerosContainer) {
        pasajerosContainer.hidden = allowed === 0;
      }
      if (pasajerosLabel) {
        pasajerosLabel.hidden = allowed === 0;
      }
      if (pasajerosSearch) {
        pasajerosSearch.disabled = allowed === 0;
        if (allowed === 0) {
          pasajerosSearch.value = "";
        }
      }
      if (pasajerosDropdown && allowed === 0) {
        pasajerosDropdown.hidden = true;
      }
      pasajerosSelect.required = allowed > 0;
      pasajerosSelect.disabled = allowed === 0;
      if (allowed === 0) {
        Array.from(pasajerosSelect.selectedOptions).forEach(option => {
          option.selected = false;
        });
      } else if (pasajerosSelect.selectedOptions.length > allowed) {
        const selected = Array.from(pasajerosSelect.selectedOptions);
        selected.slice(allowed).forEach(option => {
          option.selected = false;
        });
      }
      pasajerosCombobox?.updateChips();
      pasajerosCombobox?.updateCount();
    };

    pasajerosInput.addEventListener("input", enforcePassengerLimit);
    pasajerosInput.addEventListener("change", enforcePassengerLimit);
    enforcePassengerLimit();

    formEl.addEventListener("submit", (event) => {
      const pasajerosSelect = document.getElementById(pasajerosSelectId);
      if (!pasajerosSelect) {
        return;
      }
      const total = Number.parseInt(pasajerosInput.value, 10);
      const seleccionados = pasajerosSelect.selectedOptions.length;

      if (!Number.isFinite(total) || total < 0 || total > MAX_PASAJEROS || total !== seleccionados) {
        event.preventDefault();
        alert(`El número de pasajeros debe ser de 0 a ${MAX_PASAJEROS} y coincidir con los nombres seleccionados.\nIndicado: ${total}, Seleccionados: ${seleccionados}`);
      }
    });
  };

  setupPassengerValidation(
    solicitudForm,
    noPasajerosInput,
    "pasajeros_ids",
    pasajerosCombobox,
    "pasajeros_container",
    "pasajeros_label",
  );

  if (solicitudForm) {
    solicitudForm.addEventListener("submit", (event) => {
      if (fechaSolicitudInput) {
        const state = clampToWorkweek(fechaSolicitudInput.value);
        fechaSolicitudInput.min = state.minIso;
        fechaSolicitudInput.max = state.maxIso;
        if (!state.ok) {
          event.preventDefault();
          fechaSolicitudInput.value = state.value;
          alert("La fecha de salida debe estar dentro de los dias habiles permitidos.");
        }
      }
    });
  }
</script>

{% endblock %}
