{% extends "base.html" %}

{% block title %}Panel del usuario · Inventario vehicular{% endblock %}

{% block content %}
<section class="page-header">
  <div>
    <h2>Solicitud de unidades</h2>
    <p>Complete el formulario oficial para registrar la salida de una unidad.</p>
  </div>
</section>

<section class="grid">
  <div class="card">
    <div class="card-header">
      <h2>Registro de solicitud</h2>
      <p class="subtitle">Concentre datos clave en una sola captura.</p>
    </div>
    <form method="post" action="{{ url_for('solicitar') }}" class="form-sections">
      {% if error %}
      <div class="alert full">{{ error }}</div>
      {% endif %}

      <fieldset class="form-section">
        <legend>Unidad</legend>
        <label class="full">
          Placa de la unidad
          <select name="vehiculo_id" id="vehiculo_id" required>
            {% if vehiculos %}
              {% for vehiculo in vehiculos %}
              <option value="{{ vehiculo.id }}" data-marca="{{ vehiculo.marca }}" data-modelo="{{ vehiculo.modelo }}">{{ vehiculo.placa }}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled selected>No hay vehiculos registrados</option>
            {% endif %}
          </select>
        </label>
        <label>
          Marca
          <input type="text" id="marca_unidad" readonly required>
        </label>
        <label>
          Modelo
          <input type="text" id="modelo_unidad" readonly required>
        </label>
        <label class="full">
          Nombre del resguardante
          <select name="resguardante_id" required>
            {% if resguardantes %}
              {% for resguardante in resguardantes %}
              <option value="{{ resguardante.id }}">{{ resguardante.nombre }}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled selected>No hay resguardantes registrados</option>
            {% endif %}
          </select>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Personal</legend>
        <label class="full">
          Responsable del vehiculo
          <select name="responsable_usuario_id" required>
            {% if usuarios %}
              {% for usuario in usuarios %}
              <option value="{{ usuario.id }}">{{ usuario.nombre }}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled selected>No hay usuarios registrados</option>
            {% endif %}
          </select>
        </label>
        <label>
          No. de pasajeros
          <input type="text" name="no_pasajeros" id="no_pasajeros" inputmode="numeric" pattern="[0-9]+" required>
        </label>
        <label class="full">
          Nombre de los pasajeros
          <div class="multi-select">
            <div class="multi-select-toolbar">
              <input type="search" id="pasajeros_filter" class="multi-select-filter" placeholder="Buscar pasajero por nombre">
              <div class="multi-select-actions">
                <button class="btn ghost btn-small" type="button" data-action="select-all" data-target="pasajeros_ids">Seleccionar todo</button>
                <button class="btn ghost btn-small" type="button" data-action="clear" data-target="pasajeros_ids">Limpiar</button>
              </div>
            </div>
            <select name="pasajeros_ids" id="pasajeros_ids" class="multi-select-box" multiple size="6" required>
              {% if usuarios %}
                {% for usuario in usuarios %}
                <option value="{{ usuario.id }}">{{ usuario.nombre }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No hay usuarios registrados</option>
              {% endif %}
            </select>
            <div class="multi-select-meta">
              <span id="pasajeros_count" class="multi-count">0 seleccionados</span>
              <span class="multi-hint">Use Ctrl/Cmd + clic para elegir varios.</span>
            </div>
            <div id="pasajeros_chips" class="multi-chips" aria-live="polite"></div>
          </div>
          <p class="hint">Seleccione exactamente el mismo numero de pasajeros indicado.</p>
        </label>
      </fieldset>

      <fieldset class="form-section">
        <legend>Ruta y motivo</legend>
        <label class="full">
          Ruta - destino
          <div class="multi-select">
            <div class="multi-select-toolbar">
              <input type="search" id="ruta_filter" class="multi-select-filter" placeholder="Buscar destino o dependencia">
              <div class="multi-select-actions">
                <button class="btn ghost btn-small" type="button" data-action="select-all" data-target="ruta_destinos">Seleccionar todo</button>
                <button class="btn ghost btn-small" type="button" data-action="clear" data-target="ruta_destinos">Limpiar</button>
              </div>
            </div>
            <select name="ruta_destinos" id="ruta_destinos" class="multi-select-box" multiple size="6" required>
              {% if entes %}
                {% for ente in entes %}
                <option value="{{ ente.clave }}">{{ ente.nombre }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No hay destinos registrados</option>
              {% endif %}
            </select>
            <div class="multi-select-meta">
              <span id="ruta_count" class="multi-count">0 seleccionados</span>
              <span class="multi-hint">Ejemplos: Centro Historico, Zona Industrial, Delegacion Norte.</span>
            </div>
            <div id="ruta_chips" class="multi-chips" aria-live="polite"></div>
          </div>
        </label>
        <label class="full">
          Motivo de salida
          <select name="motivo_salida" required>
            <option value="Notificación de Oficio">Notificación de Oficio</option>
            <option value="Revisión de Auditoría">Revisión de Auditoría</option>
          </select>
        </label>
      </fieldset>

      <div class="actions full">
        <button class="btn primary" type="submit">Registrar solicitud y generar reporte</button>
      </div>
    </form>
</section>

<script>
  const vehiculoSelect = document.getElementById("vehiculo_id");
  const marcaInput = document.getElementById("marca_unidad");
  const modeloInput = document.getElementById("modelo_unidad");
  const noPasajerosInput = document.getElementById("no_pasajeros");
  const pasajerosSelect = document.getElementById("pasajeros_ids");
  const pasajerosFilter = document.getElementById("pasajeros_filter");
  const pasajerosCount = document.getElementById("pasajeros_count");
  const pasajerosChips = document.getElementById("pasajeros_chips");
  const rutaSelect = document.getElementById("ruta_destinos");
  const rutaFilter = document.getElementById("ruta_filter");
  const rutaCount = document.getElementById("ruta_count");
  const rutaChips = document.getElementById("ruta_chips");
  const solicitudForm = document.querySelector("form.form-sections");
  const multiActionButtons = document.querySelectorAll("[data-action][data-target]");

  const actualizarVehiculo = () => {
    const selected = vehiculoSelect?.selectedOptions?.[0];
    if (!selected) {
      return;
    }
    marcaInput.value = selected.dataset.marca || "";
    modeloInput.value = selected.dataset.modelo || "";
  };

  if (vehiculoSelect) {
    vehiculoSelect.addEventListener("change", actualizarVehiculo);
    actualizarVehiculo();
  }

  const setupMultiSelect = (selectEl, filterEl, countEl, chipsEl) => {
    if (!selectEl) {
      return;
    }

    const getVisibleOptions = () =>
      Array.from(selectEl.options).filter((option) => !option.disabled && !option.hidden);

    const getAllOptions = () =>
      Array.from(selectEl.options).filter((option) => !option.disabled);

    const updateCount = () => {
      if (!countEl) {
        return;
      }
      const total = getAllOptions().length;
      const selected = selectEl.selectedOptions.length;
      countEl.textContent = `${selected} seleccionados de ${total}`;
    };

    const updateChips = () => {
      if (!chipsEl) {
        return;
      }
      chipsEl.innerHTML = "";
      const selected = Array.from(selectEl.selectedOptions);
      if (!selected.length) {
        const empty = document.createElement("span");
        empty.className = "chip-empty";
        empty.textContent = "Sin selecciones";
        chipsEl.appendChild(empty);
        return;
      }
      selected.forEach((option) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip";
        chip.textContent = option.textContent;
        chip.addEventListener("click", () => {
          option.selected = false;
          selectEl.dispatchEvent(new Event("change"));
        });
        chipsEl.appendChild(chip);
      });
    };

    const applyFilter = () => {
      if (!filterEl) {
        return;
      }
      const term = filterEl.value.trim().toLowerCase();
      Array.from(selectEl.options).forEach((option) => {
        if (option.disabled) {
          return;
        }
        const match = option.textContent.toLowerCase().includes(term);
        option.hidden = term.length > 0 && !match;
      });
    };

    if (filterEl) {
      filterEl.addEventListener("input", () => {
        applyFilter();
      });
    }

    selectEl.addEventListener("change", () => {
      updateCount();
      updateChips();
    });
    applyFilter();
    updateCount();
    updateChips();

    return {
      selectEl,
      getVisibleOptions,
      updateCount,
    };
  };

  const pasajerosMulti = setupMultiSelect(
    pasajerosSelect,
    pasajerosFilter,
    pasajerosCount,
    pasajerosChips
  );
  const rutaMulti = setupMultiSelect(rutaSelect, rutaFilter, rutaCount, rutaChips);

  if (multiActionButtons.length) {
    multiActionButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const targetId = button.dataset.target;
        const action = button.dataset.action;
        const selectEl = document.getElementById(targetId);
        if (!selectEl) {
          return;
        }
        const visibleOptions = Array.from(selectEl.options).filter(
          (option) => !option.disabled && !option.hidden
        );
        if (action === "select-all") {
          visibleOptions.forEach((option) => {
            option.selected = true;
          });
        }
        if (action === "clear") {
          Array.from(selectEl.options).forEach((option) => {
            option.selected = false;
          });
        }
        selectEl.dispatchEvent(new Event("change"));
      });
    });
  }

  if (solicitudForm && noPasajerosInput && pasajerosSelect) {
    solicitudForm.addEventListener("submit", (event) => {
      const total = Number.parseInt(noPasajerosInput.value, 10);
      const seleccionados = pasajerosSelect.selectedOptions.length;
      if (!Number.isFinite(total) || total <= 0 || total !== seleccionados) {
        event.preventDefault();
        alert("El numero de pasajeros debe coincidir con los nombres seleccionados.");
      }
    });
  }
</script>

{% endblock %}
