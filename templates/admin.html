{% extends "base.html" %}

{% block title %}Administracion Â· Inventario vehicular{% endblock %}

{% block content %}
<section class="page-header">
  <div>
    <h2>Panel administrativo</h2>
    <p>Inventario completo, estatus de unidades y reportes oficiales.</p>
  </div>
  <div class="date-chip">
    <span>Fecha de corte</span>
    <strong>{{ today }}</strong>
  </div>
</section>

<section class="stats-grid">
  <div class="stat-card">
    <span>Unidades registradas</span>
    <strong>{{ total_vehiculos }}</strong>
    <small>Placas activas</small>
  </div>
  <div class="stat-card">
    <span>Disponibles hoy</span>
    <strong>{{ total_disponible }}</strong>
    <small>Listas para asignacion</small>
  </div>
  <div class="stat-card">
    <span>Movimientos activos</span>
    <strong>{{ movimientos_en_uso }}</strong>
    <small>{{ movimientos_alerta }} alertas</small>
  </div>
</section>

<section class="card">
  <div class="card-header">
    <div>
      <h2>Movimientos y reportes</h2>
      <p class="subtitle">Seguimiento de estatus y generacion de reportes.</p>
    </div>
    <form method="get" action="{{ url_for('admin') }}" class="actions-inline">
      <label>
        <span>Fecha</span>
        <input class="date-input" type="date" name="fecha" value="{{ fecha_consulta or '' }}">
      </label>
      <button class="btn ghost" type="submit">Filtrar</button>
      {% if fecha_consulta %}
      <a class="btn ghost" href="{{ url_for('admin') }}">Limpiar</a>
      {% endif %}
    </form>
    {% if rol in ["monitor", "admin"] %}
    <div class="actions-inline">
      <a class="btn ghost" href="{{ url_for('reporte_diario', fecha=fecha_consulta) if fecha_consulta else url_for('reporte_diario') }}">Reportes</a>
    </div>
    {% endif %}
  </div>
  {% if error %}
  <div class="alert full">{{ error }}</div>
  {% endif %}
  {% if movimientos %}
  <div class="table {% if rol == 'monitor' %}table-11{% else %}table-7{% endif %}">
    <div class="table-row header">
      <span>Folio</span>
      <span>Unidad</span>
      <span>Solicitante</span>
      {% if rol == "monitor" %}
      <span>Responsable</span>
      <span>Asignado a</span>
      <span>Tipo</span>
      {% endif %}
      {% if rol == "monitor" %}
      <span>Solicitado</span>
      {% endif %}
      <span>{% if rol == "monitor" %}Control{% else %}Solicitud{% endif %}</span>
      <span>Entrega</span>
      <span>Estatus</span>
      <span>{% if rol in ["monitor", "admin"] %}Acciones{% else %}Reporte{% endif %}</span>
    </div>
    {% for mov in movimientos %}
    <div class="table-row">
      <span class="mono">{{ mov.data.folio }}</span>
      <span>{{ mov.data.placa_unidad }}</span>
      <span>{{ mov.data.usuario_nombre }}</span>
      {% if rol == "monitor" %}
      <span>{{ mov.data.responsable_vehiculo or 'Sin responsable' }}</span>
      <span>{{ mov.data.propietarios_nombres or mov.data.resguardante_nombre or 'Sin asignacion' }}</span>
      <span>{% if mov.data.tipo == "prestamo" %}Prestamo{% else %}Solicitud{% endif %}</span>
      {% endif %}
      {% if rol == "monitor" %}
      <span>
        {% if mov.data.fecha_solicitud %}
          {{ mov.data.fecha_solicitud }} {{ mov.data.hora_solicitud_mx or "--:--" }}
        {% else %}
          -
        {% endif %}
      </span>
      {% endif %}
      <span>{{ mov.data.fecha_solicitud }}</span>
      <span>{{ mov.data.fecha_entrega or "Pendiente" }}</span>
      <span>
        {% if mov.data.rechazado %}
          Rechazado
        {% elif mov.data.conflicto and not mov.data.fecha_entrega %}
          Conflicto
        {% elif mov.data.devuelto %}
          Devuelto
        {% elif mov.alerta %}
          Alerta +7 dias
        {% elif mov.data.fecha_entrega %}
          En uso
        {% else %}
          Pendiente
        {% endif %}
      </span>
      <span class="actions-inline">
        {% if rol == "monitor" %}
          {% if mov.data.tipo == "prestamo" %}
            {% if mov.data.rechazado %}
              <span class="badge danger">Rechazado</span>
            {% elif mov.data.fecha_entrega %}
              <span class="badge success">Validado</span>
            {% else %}
              <form method="post" action="{{ url_for('prestamos_validar', prestamo_id=mov.data.id) }}">
                <input type="hidden" name="fecha" value="{{ fecha_consulta or '' }}">
                <button class="btn ghost btn-small" type="submit">Validar</button>
              </form>
              <form method="post" action="{{ url_for('prestamos_rechazar', prestamo_id=mov.data.id) }}">
                <input type="hidden" name="fecha" value="{{ fecha_consulta or '' }}">
                <button class="btn danger btn-small" type="submit" onclick="return confirm('Confirmar rechazo?')">Rechazar</button>
              </form>
            {% endif %}
          {% else %}
            {% if mov.data.rechazado %}
              <span class="badge danger">Rechazado</span>
            {% elif mov.data.fecha_entrega %}
              <span class="badge success">Validado</span>
            {% else %}
              <form method="post" action="{{ url_for('movimientos_entregar', mov_id=mov.data.id) }}">
                <input type="hidden" name="fecha" value="{{ fecha_consulta or '' }}">
                <button class="btn ghost btn-small" type="submit">Validar</button>
              </form>
              <form method="post" action="{{ url_for('movimientos_rechazar', mov_id=mov.data.id) }}">
                <input type="hidden" name="fecha" value="{{ fecha_consulta or '' }}">
                <button class="btn danger btn-small" type="submit" onclick="return confirm('Confirmar rechazo?')">Rechazar</button>
              </form>
            {% endif %}
          {% endif %}
        {% else %}
          {% if mov.data.tipo == "prestamo" %}
            {% if mov.data.rechazado %}
              <span class="badge danger">Rechazado</span>
            {% elif mov.data.fecha_entrega %}
              <span class="badge success">Validado</span>
            {% else %}
              <form method="post" action="{{ url_for('prestamos_validar', prestamo_id=mov.data.id) }}">
                <input type="hidden" name="fecha" value="{{ fecha_consulta or '' }}">
                <button class="btn ghost btn-small" type="submit">Validar</button>
              </form>
              <form method="post" action="{{ url_for('prestamos_rechazar', prestamo_id=mov.data.id) }}">
                <input type="hidden" name="fecha" value="{{ fecha_consulta or '' }}">
                <button class="btn danger btn-small" type="submit" onclick="return confirm('Confirmar rechazo?')">Rechazar</button>
              </form>
            {% endif %}
          {% else %}
            {% if mov.data.rechazado %}
              <span class="badge danger">Rechazado</span>
            {% elif mov.data.fecha_entrega %}
              <span class="badge success">Validado</span>
              <a class="btn ghost btn-small" href="{{ url_for('reporte_movimiento', mov_id=mov.data.id) }}">Reporte</a>
            {% else %}
              <form method="post" action="{{ url_for('movimientos_entregar', mov_id=mov.data.id) }}">
                <input type="hidden" name="fecha" value="{{ fecha_consulta or '' }}">
                <button class="btn ghost btn-small" type="submit">Validar</button>
              </form>
              <form method="post" action="{{ url_for('movimientos_rechazar', mov_id=mov.data.id) }}">
                <input type="hidden" name="fecha" value="{{ fecha_consulta or '' }}">
                <button class="btn danger btn-small" type="submit" onclick="return confirm('Confirmar rechazo?')">Rechazar</button>
              </form>
            {% endif %}
          {% endif %}
        {% endif %}
      </span>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="empty">Sin movimientos registrados.</p>
  {% endif %}
</section>

<section class="grid">
  <div class="card">
    <h2>Unidades registradas</h2>
    <p class="subtitle">Relacion oficial de placas activas.</p>
    {% if vehiculos %}
    <div class="table {% if rol == 'monitor' %}table-4{% else %}table-3{% endif %}">
      <div class="table-row header">
        <span>Placa</span>
        <span>Modelo</span>
        <span>Marca</span>
        {% if rol == "monitor" %}
        <span>Asignado a</span>
        {% endif %}
      </div>
      {% for vehiculo in vehiculos %}
      <div class="table-row">
        <span class="mono">{{ vehiculo.placa }}</span>
        <span>{{ vehiculo.modelo }}</span>
        <span>{{ vehiculo.marca }}</span>
        {% if rol == "monitor" %}
        <span>{{ vehiculo.propietarios_nombres or "Sin asignacion" }}</span>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="empty">No hay placas registradas.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
